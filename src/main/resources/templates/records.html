<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Записи на приём</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f4f6f8;
        }
        h2 {
            text-align: center;
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #f0f0f0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        button {
            margin-right: 10px;
            padding: 10px 15px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #createForm {
            display: none;
            margin-top: 30px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        #noRecordsMessage {
            text-align: center;
            color: red;
            margin-top: 20px;
        }
        .btn {
            display: inline-block;
            padding: 8px 12px;
            text-decoration: none;
            color: white;
            background-color: #28a745;
            border-radius: 4px;
        }
        .btn-danger {
            background-color: #dc3545;
        }
    </style>
</head>
<body>

<h2>Записи на приём</h2>

<div id="createForm">
    <h3>Добавить запись</h3>
    <div class="form-group">
        <label>Имя клиента:</label>
        <input type="text" id="clientName" required>
    </div>
    <div class="form-group">
        <label>Фамилия клиента:</label>
        <input type="text" id="clientSurname" required>
    </div>
    <div class="form-group">
        <label>ID врача:</label>
        <input type="number" id="doctorId" required>
    </div>
    <div class="form-group">
        <label>Дата приёма:</label>
        <input type="date" id="appointmentDate" required>
    </div>
    <div class="form-group">
        <label>Время приёма:</label>
        <input type="time" id="appointmentTime" required>
    </div>
    <div class="form-group">
        <label>Услуга:</label>
        <input type="text" id="serviceName" required>
    </div>
    <button onclick="submitRecord()">Сохранить</button>
</div>

<div id="noRecordsMessage">Нет записей на приём</div>

<table id="recordsTable" style="display: none;">
    <thead>
    <tr>
        <th>ID</th>
        <th>Клиент</th>
        <th>Доктор</th>
        <th>Дата приёма</th>
        <th>Время приёма</th>
        <th>Услуга</th>
        <th>Действия</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
    // Глобальные переменные
    let userRoles = [];
    let currentUserId = null;
    const token = localStorage.getItem('jwtToken');

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', () => {
        if (!token) {
            alert("Вы не авторизованы");
            window.location.href = "/login.html";
            return;
        }

        try {
            const payload = decodeJwt(token);
            if (!payload) throw new Error("Неверный токен");

            currentUserId = parseInt(payload.sub || payload.userId || payload.id, 10);
            userRoles = Array.isArray(payload.authorities)
                ? payload.authorities
                : (payload.authorities ? [payload.authorities] : []);

            console.log("Текущий пользователь:", { id: currentUserId, roles: userRoles });

            // Показываем форму только для врачей и админов
            if (userRoles.includes('ROLE_DOCTOR') || userRoles.includes('ROLE_ADMIN')) {
                document.getElementById('createForm').style.display = 'block';
            }

            // Загружаем соответствующие записи
            loadRecords();

        } catch (error) {
            console.error("Ошибка инициализации:", error);
            alert("Ошибка авторизации");
            window.location.href = "/login.html";
        }
    });

    // Декодирование JWT токена
    function decodeJwt(token) {
        try {
            return JSON.parse(atob(token.split('.')[1]));
        } catch (e) {
            console.error("Ошибка декодирования токена:", e);
            return null;
        }
    }

    // Загрузка записей в зависимости от роли
    async function loadRecords() {
        try {
            let apiUrl;
            if (userRoles.includes('ROLE_CLIENT')) {
                apiUrl = `/api/v1/appointment-records/client/${currentUserId}`;
            } else if (userRoles.includes('ROLE_DOCTOR')) {
                apiUrl = `/api/v1/appointment-records/doctor/${currentUserId}`;
            } else {
                apiUrl = '/api/v1/appointment-records';
            }

            const response = await fetch(apiUrl, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                throw new Error(`Ошибка сервера: ${response.status}`);
            }

            const records = await response.json();
            updateRecordsView(records);

        } catch (error) {
            console.error("Ошибка загрузки записей:", error);
            document.getElementById('noRecordsMessage').textContent =
                "Не удалось загрузить записи. " + error.message;
            document.getElementById('noRecordsMessage').style.display = 'block';
        }
    }

    // Обновление таблицы с записями
    function updateRecordsView(records) {
        const tbody = document.querySelector('#recordsTable tbody');
        const messageBox = document.getElementById('noRecordsMessage');
        tbody.innerHTML = '';

        if (!records || records.length === 0) {
            messageBox.textContent = 'Нет записей на приём';
            messageBox.style.display = 'block';
            document.getElementById('recordsTable').style.display = 'none';
            return;
        }

        messageBox.style.display = 'none';
        document.getElementById('recordsTable').style.display = 'table';

        records.forEach(record => {
            const tr = document.createElement('tr');
            tr.dataset.recordId = record.id;

            tr.innerHTML = `
                <td>${record.id}</td>
                <td>${record.clientName || ''} ${record.clientSurname || ''}</td>
                <td>${record.doctorName || ''}</td>
                <td>${record.appointmentDate || ''}</td>
                <td>${record.appointmentTime || ''}</td>
                <td>${record.serviceName || ''}</td>
                <td>
                    ${hasEditAccess(record) ? `
                        <button onclick="editRecord(${record.id})">Редактировать</button>
                        <button class="btn-danger" onclick="deleteRecord(${record.id})">Удалить</button>
                    ` : ''}
                    <a href="/my-records?recordId=${record.id}" class="btn">История</a>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Проверка прав на редактирование
    function hasEditAccess(record) {
        if (userRoles.includes('ROLE_ADMIN')) return true;
        if (userRoles.includes('ROLE_DOCTOR') && record.doctorId === currentUserId) return true;
        return false;
    }

    // Создание новой записи
    async function submitRecord() {
        try {
            const newRecord = {
                clientName: document.getElementById('clientName').value.trim(),
                clientSurname: document.getElementById('clientSurname').value.trim(),
                doctorId: parseInt(document.getElementById('doctorId').value),
                appointmentDate: document.getElementById('appointmentDate').value,
                appointmentTime: document.getElementById('appointmentTime').value,
                serviceName: document.getElementById('serviceName').value.trim()
            };

            // Валидация
            if (!newRecord.clientName || !newRecord.clientSurname || isNaN(newRecord.doctorId) ||
                !newRecord.appointmentDate || !newRecord.appointmentTime || !newRecord.serviceName) {
                throw new Error("Заполните все поля");
            }

            const response = await fetch('/api/v1/appointment-records', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(newRecord)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || "Ошибка создания записи");
            }

            alert("Запись успешно создана");
            // Очищаем форму
            document.getElementById('clientName').value = '';
            document.getElementById('clientSurname').value = '';
            document.getElementById('doctorId').value = '';
            document.getElementById('appointmentDate').value = '';
            document.getElementById('appointmentTime').value = '';
            document.getElementById('serviceName').value = '';

            // Обновляем список
            loadRecords();

        } catch (error) {
            console.error("Ошибка создания записи:", error);
            alert("Ошибка: " + error.message);
        }
    }

    // Удаление записи
    async function deleteRecord(id) {
        if (!confirm("Вы уверены, что хотите удалить эту запись?")) return;

        try {
            const response = await fetch(`/api/v1/appointment-records/${id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                throw new Error("Ошибка удаления записи");
            }

            alert("Запись успешно удалена");
            loadRecords();

        } catch (error) {
            console.error("Ошибка удаления записи:", error);
            alert("Ошибка: " + error.message);
        }
    }

    // Редактирование записи
    function editRecord(id) {
        const row = document.querySelector(`tr[data-record-id="${id}"]`);
        if (!row) return;

        const cells = row.cells;
        const currentData = {
            clientName: cells[1].textContent.split(' ')[0],
            clientSurname: cells[1].textContent.split(' ')[1] || '',
            doctorId: cells[2].textContent.split(' ')[0] || '',
            appointmentDate: cells[3].textContent,
            appointmentTime: cells[4].textContent,
            serviceName: cells[5].textContent
        };

        row.innerHTML = `
            <td>${id}</td>
            <td>
                <input type="text" value="${currentData.clientName}" id="editClientName">
                <input type="text" value="${currentData.clientSurname}" id="editClientSurname">
            </td>
            <td><input type="number" value="${currentData.doctorId}" id="editDoctorId"></td>
            <td><input type="date" value="${currentData.appointmentDate}" id="editAppointmentDate"></td>
            <td><input type="time" value="${currentData.appointmentTime}" id="editAppointmentTime"></td>
            <td><input type="text" value="${currentData.serviceName}" id="editServiceName"></td>
            <td>
                <button onclick="saveEditedRecord(${id})">Сохранить</button>
                <button onclick="loadRecords()">Отмена</button>
            </td>
        `;
    }

    // Сохранение отредактированной записи
    async function saveEditedRecord(id) {
        try {
            const editedRecord = {
                clientName: document.getElementById('editClientName').value.trim(),
                clientSurname: document.getElementById('editClientSurname').value.trim(),
                doctorId: parseInt(document.getElementById('editDoctorId').value),
                appointmentDate: document.getElementById('editAppointmentDate').value,
                appointmentTime: document.getElementById('editAppointmentTime').value,
                serviceName: document.getElementById('editServiceName').value.trim()
            };

            // Валидация
            if (!editedRecord.clientName || !editedRecord.clientSurname || isNaN(editedRecord.doctorId) ||
                !editedRecord.appointmentDate || !editedRecord.appointmentTime || !editedRecord.serviceName) {
                throw new Error("Заполните все поля");
            }

            const response = await fetch(`/api/v1/appointment-records/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(editedRecord)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || "Ошибка сохранения изменений");
            }

            alert("Изменения успешно сохранены");
            loadRecords();

        } catch (error) {
            console.error("Ошибка сохранения записи:", error);
            alert("Ошибка: " + error.message);
        }
    }
</script>
</body>
</html>