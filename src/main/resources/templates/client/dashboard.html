<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<th:block th:replace="~{layout/base :: maket(~{::dashboard})}">
    <th:block th:fragment="dashboard">

        <h2>Переход на dashboard.html после login.html</h2>
        <h1>Добро пожаловать в личный кабинет</h1>

        <div class="logout-container">
            <button id="logoutBtn">Выйти</button>
            <script src="/js/logout.js"></script>
        </div>


        <div th:if="${успешно}" class="alert success">
            <p th:text="${успешно}">Профиль обновлен</p>
        </div>

        <div th:if="${ошибка}" class="alert error">
            <p th:text="${ошибка}">Ошибка при обновлении профиля</p>
        </div>

        <h2 th:unless="${isAdminOrDoctor}">Ваш профиль</h2>
        <form th:unless="${isAdminOrDoctor}" th:action="@{/client/profile}" method="post" th:object="${client}" >
            <label>Имя:
                <input type="text" th:field="*{firstName}" required/>
            </label><br/>

            <label>Фамилия:
                <input type="text" th:field="*{lastName}" required/>
            </label><br/>

            <label>Возраст:
                <input type="number" th:field="*{age}" required/>
            </label><br/>

            <label>Пол:
                <input type="text" th:field="*{gender}" required/>
            </label><br/>

            <label>Адрес:
                <input type="text" th:field="*{address}" required/>
            </label><br/>

            <label>Паспорт:
                <input type="text" th:field="*{passport}" required/>
            </label><br/>

            <button type="submit">Обновить профиль</button>
        </form>

        <!-- Список пациентов — только для DOCTOR / ADMIN -->
        <!--
        <div th:if="${isAdminOrDoctor}">
            <h2>Список пациентов</h2>
            <table border="1">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Логин</th>
                        <th>Имя</th>
                        <th>Фамилия</th>
                        <th>Возраст</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="c : ${allClients}">
                        <td th:text="${c.id}">ID</td>
                        <td th:text="${c.login}">login</td>
                        <td th:text="${c.firstName}">Имя</td>
                        <td th:text="${c.lastName}">Фамилия</td>
                        <td th:text="${c.age}">30</td>
                        <td>
                            <a th:href="@{'/web/clients/' + ${c.id}}">Просмотр</a> |
                            <a th:href="@{'/web/clients/' + ${c.id} + '/edit'}">Редактировать</a> |
                            <form th:action="@{'/web/clients/' + ${c.id} + '/delete'}" method="post" style="display:inline;">
                                <button type="submit">Удалить</button>
                            </form>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        -->


        <!-- Список пациентов (React) -->
        <div th:if="${isAdminOrDoctor}">
            <h2>Список пациентов</h2>
            <div id="react-patient-manager-container"></div>
        </div>

        <hr/>


        <!-- Записи на приём (React) -->
        <div th:if="${isAdminOrDoctor}">
            <h2>Записи всех пациентов</h2>
            <div id="react-appointment-record-manager-container"></div>
        </div>


        <!-- Сообщение для доктора / админа -->
        <div th:if="${isAdminOrDoctor}">
            <p>Вы можете просматривать все записи, но не можете создавать новые.</p>
        </div>

        <hr/>

        <!-- История болезней React -->
        <div>
            <h2 th:if="${isAdminOrDoctor}">История болезни</h2>
            <h2 th:unless="${isAdminOrDoctor}">Ваша история болезни</h2>
            <div id="react-disease-history-manager-container" th:attr="data-user-role=${role}"></div>
        </div>

        <!-- История болезней -->
        <h2>История болезней</h2>
        <table border="1">
            <thead>
                <tr>
                    <th>Начало лечения</th>
                    <th>Окончание</th>
                    <th>Диагноз</th>
                    <th>Врач</th>
                    <th>Профессия</th>
                    <th th:if="${isAdminOrDoctor}">ID клиента</th>
                    <th th:if="${isAdminOrDoctor}">Действия</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="history : ${diseaseHistories}">
                    <td th:text="${#temporals.format(history.startDate, 'yyyy-MM-dd HH:mm')}">2025-05-01 12:00</td>
                    <td th:text="${#temporals.format(history.endDate, 'yyyy-MM-dd HH:mm')}">2025-05-10 13:00</td>
                    <td th:text="${history.disease}">Грипп</td>
                    <td th:text="${history.firstNameDoctor + ' ' + history.lastNameDoctor}">Иванов И.И.</td>
                    <td th:text="${history.profession}">Терапевт</td>

                    <!-- Только доктор и админ видят ID клиента -->
                    <td th:if="${isAdminOrDoctor}" th:text="${history.clientId}">1</td>

                    <!-- Действия — только для доктора / админа -->
                    <td th:if="${isAdminOrDoctor}">
                        <a th:href="@{'/web/disease-history/' + ${history.recordId}}">Просмотр</a> |
                        <a th:href="@{'/web/disease-history/' + ${history.recordId} + '/edit'}">Редактировать</a> |
                        <form th:action="@{'/web/disease-history/' + ${history.recordId} + '/delete'}" method="post" style="display:inline;">
                            <button type="submit">Удалить</button>
                        </form>
                    </td>
                </tr>
            </tbody>
        </table>

        <hr/>

        <!-- Результаты анализов -->
        <div>
            <h2 th:if="${isAdminOrDoctor}">Все результаты анализов</h2>
            <h2 th:unless="${isAdminOrDoctor}">Ваши результаты анализов</h2>
            <div id="react-analysis-result-manager-container" th:attr="data-user-role=${role}"></div>
        </div>


        <!-- Таблица докторов React -->
        <div>
            <h2>Таблица докторов</h2>
            <div id="react-doctor-manager-container" th:attr="data-user-role=${role}"></div>
        </div>

        <!-- Таблица докторов -->
        <h2>Таблица докторов</h2>
        <th:block th:replace="~{doctor/list :: content}"></th:block>

        <!-- Модальное окно добавления доктора -->
        <div id="addDoctorModal" class="modal" th:if="${isAdminOrDoctor}">
            <div class="modal-content">
                <span class="close-btn" onclick="closeModal('addDoctorModal')">&times;</span>
                <h2>Добавить нового доктора</h2>
                <form id="addDoctorForm" method="post" action="/web/doctors">
                    <label>Фамилия: <input type="text" name="lastName" required/></label><br>
                    <label>Имя: <input type="text" name="firstName" required/></label><br>
                    <label>Специализация: <input type="text" name="specialization" required/></label><br>
                    <label>Опыт: <input type="text" name="experience" required/></label><br>
                    <label>Логин: <input type="text" name="login" required/></label><br>
                    <label>Пароль: <input type="password" name="password" required/></label><br>
                    <button type="submit">Сохранить</button>
                </form>
            </div>
        </div>

        <!-- Модальное окно редактирования доктора -->
        <div id="editDoctorModal" class="modal">
            <div class="modal-content">
                <span class="close-btn" onclick="closeModal('editDoctorModal')">&times;</span>
                <h2>Редактировать доктора</h2>
                <form id="editDoctorForm" method="post">
                    <input type="hidden" name="id" id="editDoctorId" />
                    <label>Фамилия: <input type="text" name="lastName" id="editLastName" /></label><br>
                    <label>Имя: <input type="text" name="firstName" id="editFirstName" /></label><br>
                    <label>Специализация: <input type="text" name="specialization" id="editSpecialization" /></label><br>
                    <label>Опыт: <input type="text" name="experience" id="editExperience" /></label><br>
                    <label>Логин: <input type="text" name="login" id="editLogin" /></label><br>
                    <label>Пароль: <input type="password" name="password" id="editPassword" /></label><br>
                    <button type="submit">Сохранить</button>
                    <button type="button" onclick="closeModal('editDoctorModal')">Закрыть</button>
                </form>
            </div>
        </div>

        <!--
        <div sec:authorize="hasRole('ADMIN')">
            <a th:href="@{/auth/register/doctor}">Зарегистрировать доктора</a>
        </div>
        -->
        <div sec:authorize="hasRole('ADMIN')">
            <a th:href="@{/auth/register/client}">Зарегистрировать нового клиента</a>
        </div>


        <a href="#" sec:authorize="hasRole('ADMIN')" onclick="openAddDoctorModal()">Добавить доктора</a>

    </th:block>
</th:block>
</html>
